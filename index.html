<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>每日吃藥提醒</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; }
        
        #app {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            transition: background-color 0.5s ease;
            color: white;
            text-align: center;
            position: relative;
        }

        /* 狀態顏色 */
        .bg-green { background-color: #28a745; } /* 吃藥時間 */
        .bg-red { background-color: #dc3545; }   /* 未吃藥 */
        .bg-black { background-color: #000000; } /* 已吃藥 / 等待中 */

        /* 懸浮時間視窗 */
        #floating-clock {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 10px 15px;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            text-align: right;
            pointer-events: none; /* 讓點擊穿透，避免擋住操作 */
            line-height: 1.4;
        }

        h1 { font-size: 4rem; margin: 0 0 20px 0; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        p { font-size: 1.2rem; margin: 10px 0; opacity: 0.9; }

        /* 按鈕樣式 */
        #check-in-btn {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        #check-in-btn:active { transform: scale(0.95); }

        /* 倒數計時圓環 */
        .progress-ring {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }
        .progress-circle {
            fill: transparent;
            stroke: white;
            stroke-width: 8;
            stroke-dasharray: 440; 
            stroke-dashoffset: 440;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.1s linear;
        }

        /* 打勾特效 */
        .checkmark {
            display: none;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            stroke-width: 5;
            stroke: #fff;
            stroke-miterlimit: 10;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }
        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.5s forwards;
        }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }

        /* 重置按鈕 */
        #reset-container {
            position: absolute;
            bottom: 30px;
        }
        #reset-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* 隱藏元素 */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app" class="bg-black">
    <div id="floating-clock">--/--/-- <br> --:--:--</div>

    <h1 id="status-text">載入中...</h1>
    <p id="sub-text"></p>
    
    <div id="btn-container">
        <button id="check-in-btn">
            <span id="btn-text">簽到</span>
            <svg class="progress-ring">
                <circle class="progress-circle" cx="75" cy="75" r="70"></circle>
            </svg>
        </button>
    </div>

    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    </svg>

    <div id="reset-container">
        <button id="reset-btn" onclick="confirmReset()">重置狀態</button>
    </div>
</div>

<script>
    // --- PWA Service Worker 註冊 ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
        .catch(err => console.log('SW registration failed:', err));
    }

    // --- 變數與設定 ---
    const STORAGE_KEY = 'med_tracker_v1';
    const START_HOUR = 6;
    const END_HOUR = 11;
    
    // 簡單的提示音效
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    function playSound() {
        if(audioContext.state === 'suspended') audioContext.resume();
        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(500, audioContext.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        osc.start();
        osc.stop(audioContext.currentTime + 0.5);
    }

    // --- 懸浮時鐘邏輯 ---
    function updateClock() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        
        const days = ['日', '一', '二', '三', '四', '五', '六'];
        const dayOfWeek = days[now.getDay()];

        document.getElementById('floating-clock').innerHTML = 
            `${year}/${month}/${date} (${dayOfWeek})<br>${hours}:${minutes}:${seconds}`;
    }
    setInterval(updateClock, 1000);
    updateClock(); // 立即執行一次，避免載入時顯示空白

    // --- 狀態管理 ---
    let state = {
        lastTakenDate: null, 
    };

    function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) state = JSON.parse(saved);
    }

    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function getTodayString() {
        const d = new Date();
        return d.toISOString().split('T')[0];
    }

    function getTodayString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${date}`;
    }

    // --- UI 更新邏輯 ---
    const app = document.getElementById('app');
    const statusText = document.getElementById('status-text');
    const subText = document.getElementById('sub-text');
    const btnContainer = document.getElementById('btn-container');
    const checkmark = document.querySelector('.checkmark');
    const btnText = document.getElementById('btn-text');

    function updateUI() {
        const now = new Date();
        const hour = now.getHours();
        const todayStr = getTodayString();
        const isTakenToday = state.lastTakenDate === todayStr;

        if (!isTakenToday) {
            checkmark.style.display = 'none';
            btnContainer.classList.remove('hidden');
        }

        // 1. 已吃藥狀態 (包含空窗期)
        if (isTakenToday || hour < START_HOUR) {
            app.className = 'bg-black';
            statusText.innerText = '已吃藥';
            
            let nextTarget = new Date();
            nextTarget.setHours(START_HOUR, 0, 0, 0);
            if (now > nextTarget) {
                nextTarget.setDate(nextTarget.getDate() + 1); 
            }
            
            const diff = nextTarget - now;
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            subText.innerText = `距離下次吃藥還有 ${h} 小時 ${m} 分鐘`;
            
            btnContainer.classList.add('hidden'); 
            if(isTakenToday) checkmark.style.display = 'block'; 
            return;
        }

        // 2. 吃藥時間 (06:00 - 11:00) 且未吃
        if (hour >= START_HOUR && hour < END_HOUR) {
            app.className = 'bg-green';
            statusText.innerText = '吃藥';
            subText.innerText = '早安，請記得按時服藥';
            btnContainer.classList.remove('hidden');
            checkmark.style.display = 'none';
            return;
        }

        // 3. 過期未吃 (11:00 以後)
        if (hour >= END_HOUR && !isTakenToday) {
            app.className = 'bg-red';
            statusText.innerText = '未吃藥';
            
            let missedCount = 1;
            if (state.lastTakenDate) {
                const daysSince = getDaysDiff(state.lastTakenDate);
                missedCount = daysSince > 0 ? daysSince : 1; 
            }
            if(!state.lastTakenDate) missedCount = 1; 

            subText.innerText = `已錯過時間！漏吃次數：${missedCount} 次\n請補簽到`;
            btnContainer.classList.remove('hidden');
            checkmark.style.display = 'none';
        }
    }

    // --- 長按邏輯 ---
    const btn = document.getElementById('check-in-btn');
    const circle = document.querySelector('.progress-circle');
    let pressTimer;
    let startTime;
    const DURATION = 2000; 

    function startPress(e) {
        e.preventDefault(); 
        startTime = Date.now();
        btn.style.transform = "scale(0.9)";
        requestAnimationFrame(checkPress);
    }

    function checkPress() {
        if (!startTime) return; 
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / DURATION, 1);
        
        const offset = 440 - (440 * progress);
        circle.style.strokeDashoffset = offset;
        
        const remaining = Math.ceil((DURATION - elapsed) / 1000);
        btnText.innerText = remaining > 0 ? remaining : "OK";

        if (elapsed >= DURATION) {
            completeCheckIn();
            resetPress();
        } else {
            requestAnimationFrame(checkPress);
        }
    }

    function resetPress() {
        startTime = null;
        btn.style.transform = "scale(1)";
        circle.style.strokeDashoffset = 440; 
        btnText.innerText = "簽到";
    }

    function completeCheckIn() {
        playSound();
        state.lastTakenDate = getTodayString();
        saveState();
        btnContainer.classList.add('hidden');
        checkmark.style.display = 'block';
        setTimeout(updateUI, 100); 
    }

    btn.addEventListener('mousedown', startPress);
    btn.addEventListener('touchstart', startPress, {passive: false});
    
    btn.addEventListener('mouseup', resetPress);
    btn.addEventListener('mouseleave', resetPress);
    btn.addEventListener('touchend', resetPress);

    // --- 重置功能 ---
    function confirmReset() {
        if (confirm("確定要重置狀態嗎？這將清除今天的吃藥紀錄。")) {
            state.lastTakenDate = null;
            saveState();
            updateUI(); // 直接更新畫面，不重新整理
        }
    }

    // --- 初始化 ---
    loadState();
    updateUI();
    setInterval(updateUI, 60000); 

</script>
</body>

</html>


